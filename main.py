import os
from flask import Flask, request
import telebot
from telebot import types

TOKEN = os.getenv("TELEGRAM_TOKEN")
if not TOKEN:
    raise ValueError("⚠️ متغير البيئة TELEGRAM_TOKEN غير موجود. الرجاء إضافته في إعدادات Render.")

bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# --- قوائم الردود ---

# رسالة البداية عند /start
def start_message():
    text = (
        "🔹 *ما الذي يمكن لهذا البوت تقديمه؟*\n\n"
        "هذا البوت مُخصص لطلاب *الدبلوم في جامعة الملك سعود*، ويهدف إلى:\n\n"
        "✅ *توفير المعلومات الدراسية بسهولة وسرعة*\n"
        "✅ *مساعدة الطالب في الوصول لكل ما يحتاجه من روابط ومصادر مهمة*\n"
        "✅ *تقليل الوقت والجهد المبذول في البحث*\n"
        "✅ *تجميع كل ما يهم الطالب في مكان واحد*\n\n"
        "نأمل أن تكون هذه الخدمة عند حسن ظنكم،\n"
        "ونسعد دائمًا بخدمتكم 💙\n"
        "*جزيل الشكر والتقدير لكم 🌹*\n\n"
        "قناة مساعدات طلاب الدبلوم 👇\n"
        "https://t.me/Diploma_Solutions"
    )
    return text

# قائمة اليسار (star و help)
def left_side_keyboard():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.row("star", "help")
    return markup

# قائمة اليمين (التبويبات 1 إلى 10 + رجوع)
def right_side_keyboard():
    markup = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    markup.add(
        "التبويب الاول: تقويم عام 1447ه‍",
        "التبويب الثاني: خدمات التواصل مع الجامعة",
        "التبويب الثالث: الاسئلة الشائعة_عام",
        "التبويب الرابع: تخصصات برامج الدبلوم - حضوري",
        "التبويب الخامس: تخصصات برامج الدبلوم - عن بُعد",
        "التبويب السادس: قناة وإعلانات الدبلوم 📢",
        "التبويب السابع: خدمات حل الواجبات وعمل المشاريع والبحوث",
        "التبويب الثامن: مواقع فروع جامعة الملك سعود",
        "التبويب التاسع: التجسير",
        "التبويب العاشر: 🛑شرح استخدام – البلاك بورد / Blackboard 🛑",
        "🔙 رجوع"
    )
    return markup

# --- معالج الأوامر ---

@bot.message_handler(commands=['start'])
def start_handler(message):
    bot.send_message(
        message.chat.id,
        start_message(),
        parse_mode="Markdown",
        reply_markup=left_side_keyboard()
    )
    # بعد رسالة البداية تظهر قائمة اليمين تلقائياً للمستخدم
    bot.send_message(
        message.chat.id,
        "اختر التبويب من القائمة اليمنى:",
        reply_markup=right_side_keyboard()
    )

# --- معالج الرسائل ---

@bot.message_handler(func=lambda m: True)
def all_messages(message):
    text = message.text.strip()

    # اليسار - star و help
    if text == "star":
        bot.send_message(
            message.chat.id,
            "اضغط على الأوامر الموجودة في القائمة (قائمة في يمين البوت) أدناه لتحصل على كل ما تحتاجه:\n\n"
            "🎯 نأمل أن تنال خدمتنا رضاكم وأن نكون عند حسن ظنكم…"
        )
        # بعد الرد هنا يمكن إعادة عرض قائمة اليمين أو لا حسب رغبتك
        bot.send_message(message.chat.id, "اختر التبويب:", reply_markup=right_side_keyboard())
        return

    if text == "help":
        bot.send_message(
            message.chat.id,
            "فيديو #شــــــرح_استخدام_البوت سيتوفر قريبا"
        )
        return

    # زر الرجوع
    if text == "🔙 رجوع":
        bot.send_message(message.chat.id, "تم الرجوع إلى القائمة الرئيسية ✅", reply_markup=right_side_keyboard())
        return

    # التبويبات اليمنى (الردود المفصلة)
    if text == "التبويب الاول: تقويم عام 1447ه‍":
        bot.send_message(
            message.chat.id,
            "التقويم الدراسي للعام الجامعي 1447هـ في جامعة الملك سعود لم يُنشر بشكل رسمي بعد"
        )
        return

    if text == "التبويب الثاني: خدمات التواصل مع الجامعة":
        msg = (
            "عمادة السنه الاولى المشتركة\n"
            "SSHELP@CFY.KSU.EDU.SA\n"
            "00966-114694006\n\n"
            "الشؤون الطلابية\n"
            "ksugcc@ksu.edu.sa\n"
            "00966 1 8050141\n\n"
            "المشرف على وحدة التوجيه و الإرشاد الطلابي\n"
            "sg@cfy.ksu.edu.sa\n"
            "4694118\n"
            "رقم المكتب:  2484\n\n"
            "المشرف على وحدة شؤون الطلاب\n"
            "sa@cfy.ksu.edu.sa\n\n"
            "ايميلات عمادة القبول والتسجيل\n"
            "dar@ksu.edu.sa\n"
            "darweb@ksu.edu.sa\n\n"
            "ارقام عمادة القبول والتسجيل\n"
            "0114677722\n"
            "0118054402\n\n"
            "منسق/ة الفيزياء\n"
            "nbennessib@ksu.edu.sa\n"
            "nalkathran@ksu.edu.sa\n\n"
            "منسق احياء\n"
            "aalii@ksu.edu.sa\n"
            "somer@ksu.edu.sa\n\n"
            "منسق كيم\n"
            "amenizi@ksu.edu.sa\n"
            "zalmarhoon@ksu.edu.sa\n\n"
            "منسق/ة انجل\n"
            "mramadan@cfy.ksu.edu.sa\n"
            "h.alshareef@cfy.ksu.edu.sa\n\n"
            "فرع عليشه ( بنات)\n"
            "011 805 7331\n\n"
            "فرع الناصريه( الوشم بمسمى اخر)\n"
            "0114036600\n"
        )
        bot.send_message(message.chat.id, msg)
        return

    if text == "التبويب الثالث: الاسئلة الشائعة_عام":
        msg = (
            "●الاسئلة الشائعة -عام\n\n"
            "◇الأسئلة الشائعة حول القبول:\nhttps://dar.ksu.edu.sa/ar/FAQ\n\n"
            "◇الاسئلة الشائعة للطلاب المنتظمين:\nhttps://dar.ksu.edu.sa/ar/faqs\n\n"
            "◇الاسئلة الشائعة للطلاب الخريجين :\nhttps://dar.ksu.edu.sa/ar/gfaq"
        )
        bot.send_message(message.chat.id, msg)
        return

    if text == "التبويب الرابع: تخصصات برامج الدبلوم - حضوري":
        حضوري_text = (
            "- *دبلوم محاسبة*:\n"
            "🔹 **الدبلوم المتوسط في المحاسبة – جامعة الملك سعود**\n"
            "**الرؤية العامة:**\n"
            "يهدف البرنامج إلى الإسهام في تلبية متطلبات سوق العمل السعودي من الكوادر المؤهلة في مجال المحاسبة، من خلال إعداد خريجين يمتلكون المعارف والمهارات اللازمة لأداء المهام المحاسبية بكفاءة واحترافية.\n\n"
            "### 🎯 **الأهداف الرئيسة للبرنامج:**\n"
            "✅ توفير بيئة أكاديمية متطورة لإعداد كوادر متميزة في المجال المحاسبي وفق منهج علمي دقيق.\n"
            "✅ تأهيل الطلبة بأحدث المفاهيم والمعارف النظرية والتطبيقية في المحاسبة.\n"
            "✅ تنمية المهارات الفكرية والبحثية للطلاب للعمل بكفاءة عالية في بيئات العمل المحاسبية.\n"
            "✅ تطوير المهارات العملية لإنجاز الأنشطة والعمليات المحاسبية المتنوعة.\n"
            "✅ تدريب الطلاب على استخدام الحاسب الآلي والتطبيقات المحاسبية الحديثة بكفاءة.\n"
            "✅ تقديم مرجعية علمية تجمع بين الجانب النظري والتطبيقي في مجال الأعمال المالية والمصرفية لخدمة الجامعات السعودية.\n\n"
            "---\n\n"
            "### 📚 **الخطة الدراسية ووصف المقررات:**\n\n"
            "* 🔸 [الخطة الدراسية للدبلوم المتوسط في المحاسبة (الجديدة)](https://ascs.ksu.edu.sa/sites/ascs.ksu.edu.sa/files/attach/%D8%A7%D9%84%D9%85%D8%AD%D8%A7%D8%B3%D8%A8%D8%A9_0.pdf)\n"
            "* 🔸 [وصف المقررات الدراسية للدبلوم المتوسط في المحاسبة (الجديدة)](https://ascs.ksu.edu.sa/sites/ascs.ksu.edu.sa/files/attach/wsf_lmqrrt_ldblwm_lmhsb.pdf)\n\n"
            "---\n\n"
            "### 💼 **الفرص الوظيفية للخريجين:**\n\n"
            "يتيح البرنامج لخريجيه العمل في القطاعين الحكومي والخاص ضمن مجالات متنوعة مثل:\n"
            "* مساعد محاسب\n"
            "* محصل إيرادات\n"
            "* مأمور مبيعات\n"
            "* أمين صندوق\n"
            "* مأمور عهد\n"
            "* مراقب عهد\n"
            "* مراقب مخازن\n"
            "* أمين مستودع\n"
            "* مفتش تموين\n"
            "* مأمور مشتريات\n"
            "* مراقب تجاري\n"
            "* مساعد مدقق حسابات\n"
            "* كاتب إداري في الإدارة المالية\n"
            "* مساعد مدرب في مجال التخصص\n\n"
            "https://t.me/SaudDiploma_bot\n\n"
            "🔙 رجوع"
        )
        bot.send_message(message.chat.id, حضوري_text, parse_mode="Markdown")
        return

    if text == "التبويب الخامس: تخصصات برامج الدبلوم - عن بُعد":
        عن_بعد_text = (
            "• شرح - البلاك بورد / Blackboard\n"
            "عند الضغط عليه يعرض رسالة :\n"
            "شرح استخدام- البلاك بورد/  Blackboard ⤵️\n"
            "https://t.me/Diploma_Solutions/16\n\n"
            "• دبلوم الإدارة المالية والمصرفية - عن بعد\n"
            "تعريف بالتخصص :\n\n"
            "فيما يلي **ملخص منظم وشامل** لبرنامج *الدبلوم المتوسط في الإدارة المالية والمصرفية*، مقسم حسب الأجزاء الرئيسية:\n\n"
            "---\n\n"
            "### 🎯 أهداف البرنامج:\n\n"
            "1. **إكساب الطلاب المعرفة الأساسية** بالمفاهيم والمبادئ والأنظمة في الإدارة المالية والمصرفية.\n"
            "2. **تهيئة الطلاب للتطورات الحديثة** في القطاع المالي والمصرفي.\n"
            "3. **تأهيل الطلاب للعمل في الوظائف المالية والمصرفية** المتنوعة.\n"
            "4. **تنمية مهاراتهم العلمية والحسابية**، إلى جانب مهارات التواصل وتقنية المعلومات.\n\n"
            "---\n\n"
            "### 🎓 مخرجات تعلم البرنامج:\n\n"
            "#### أولاً: المعرفة:\n"
            "* التعرف على **خصائص الأدوات المالية** وأساليب التحليل المالي.\n"
            "* فهم **أنواع المؤسسات والوسطاء الماليين** وأدوارهم.\n"
            "* إدراك **أساسيات الإدارة المالية والاستثمار**.\n"
            "* متابعة **التطورات والنظريات الحديثة** في القطاع المالي والمصرفي.\n\n"
            "#### ثانيًا: المهارات الإدراكية:\n"
            "* استخدام **البيانات المالية** في التحليل وتقييم المشاريع.\n"
            "* تحليل **القضايا المالية والتنبؤ بالمخاطر** واتخاذ القرار.\n"
            "* التمييز بين **الممارسات المالية المختلفة**.\n"
            "* تقييم **تغير المعلومات المالية بسرعة وفعالية**.\n\n"
            "#### ثالثًا: مهارات التعامل مع الأشخاص وتحمل المسؤولية:\n"
            "* الوعي بـ **الجوانب الأخلاقية** المرتبطة بالمهنة.\n"
            "* التفاعل والعمل ضمن **فرق العمل المتخصصة** لتحقيق أهداف التخصص.\n\n"
            "#### رابعًا: مهارات الاتصال، التقنية، والحساب:\n"
            "* إتقان مهارات **الاتصال الشفهي والكتابي** باستخدام التقارير والعروض والبريد الإلكتروني.\n"
            "* توظيف **التحليل الكمي والعددي** في حل المشكلات.\n"
            "* استخدام **الحاسب الآلي** في المهام المالية والمصرفية.\n\n"
            "### 💼 الفرص الوظيفية:\n\n"
            "يتيح البرنامج فرصًا وظيفية في قطاعات واسعة مثل:\n"
            "* **المنشآت الاقتصادية بأنواعها**\n"
            "* **المصارف التجارية والإسلامية**\n"
            "* **شركات التأمين**\n"
            "* **البنك المركزي السعودي**\n"
            "* **مكاتب الصرافة**\n"
            "* **القطاعات المالية في الجهات الحكومية**\n"
            "* **وزارة المالية وأجهزتها المختلفة**\n\n"
            "#### أمثلة للوظائف:\n"
            "* أمين صندوق\n"
            "* مأمور صرف\n"
            "* مساعد مدير مالي\n"
            "* مراقب مالي\n"
            "* عدّاد نقود\n"
            "* مدقق حسابات\n"
            "* محصّل إيرادات\n"
            "* مراقب تجاري\n"
            "* وغيرها من الوظائف ذات الصلة بالمجال المالي والمصرفي.\n\n"
            "https://t.me/SaudDiploma_bot\n\n"
            "- الخطة الدراسية :\n"
            "◆الخطة الدراسية للدبلوم المتوسط في الإدارة المالية والمصرفية ⤵️:\n"
            "https://drive.google.com/file/d/11Re6r3MibiqyMxrlg0jh-X_SZGrOu5Cb/view?usp=drivesdk\n\n"
            "https://t.me/SaudDiploma_bot\n\n"
            "- وصف المقررات:\n"
            "◆وصف مقررات دبلوم الإدارة المالية والمصرفية\n"
            "https://drive.google.com/file/d/11OtBZQauC278G2cqTkh2fSruXLHrqlf3/view?usp=drivesdk\n\n"
            "https://t.me/SaudDiploma_bot\n\n"
            "🔙 رجوع"
        )
        bot.send_message(message.chat.id, عن_بعد_text)
        return

    if text == "التبويب السادس: قناة وإعلانات الدبلوم 📢":
        msg = (
            "♦ (قناة أخبار) دبلومات جامعة الملك سعود:\n"
            "🔗 https://t.me/KSDN_222\n\n"
            "♦ قناة تابعة لقروب دبلوم جامعة الملك سعود:\n"
            "قناة خاصة بحلول واجبات واختبارات مواد الدبلوم بجامعة الملك سعود KSU\n"
            "🔗 https://t.me/Diploma_Solutions"
        )
        bot.send_message(message.chat.id, msg)
        return

    if text == "التبويب السابع: خدمات حل الواجبات وعمل المشاريع والبحوث":
        msg = (
            "🎓 **منصة عونك الأكاديمية – لجميع طلاب دبلومات جامعة الملك سعود**\n\n"
            "🔸 *سواء كنت طالبًا مستجدًا أو في أحد المستويات المتقدمة، وفرنا لك كل ما تحتاجه في مكانٍ واحد.*\n\n"
            "💼 **خدماتنا تشمل:**\n\n"
            "▪️ حل الواجبات الأكاديمية بجودة عالية\n"
            "▪️ إعداد البحوث والتقارير الاحترافية (Word | PDF | Excel)\n"
            "▪️ تصميم العروض التقديمية PowerPoint بأسلوب مميز\n"
            "▪️ تنفيذ المشاريع الدراسية بدقة واحترافية\n"
            "▪️ دعم كامل في الأعمال الفصلية ومهام المواد\n\n"
            "🧠 نضم فريقًا من **المتخصصين الأكاديميين** في مختلف المجالات، نختار الأنسب لطلبك لضمان أعلى جودة ممكنة.\n\n"
            "📌 تابع قناتنا الرسمية لجميع الخدمات الطلابية:\n"
            "🔗 [منصتي – خدمات طلاب دبلوم جامعة الملك سعود]: https://t.me/Diploma_Solutions\n"
            "https://t.me/Aoun_Academic\n\n"
            "💬 للتواصل وطلب الخدمات مباشرة:\n"
            "🔗 [اضغط هنا للتواصل عبر الواتساب](https://wa.me/967733365187)\n\n"
            "⭐️ *جودة، سرعة، خصوصية – لأن نجاحك هو هدفنا.*\n\n"
            "✍️ **معكم خطوة بخطوة حتى التخرج – دمتم بخير 🌿**"
        )
        bot.send_message(message.chat.id, msg, parse_mode="Markdown")
        return

    if text == "التبويب الثامن: مواقع فروع جامعة الملك سعود":
        msg = (
            "⚪️ مواقع فروع جامعة الملك سعود:\n\n"
            "▫️ عليشة (بنات): https://maps.app.goo.gl/nHSKPBWHqAdvspmz8?g_st=it\n"
            "▫️ الروابي (مشترك): https://maps.app.goo.gl/1Xf9MqXCPs9fVkng7?g_st=it\n"
            "▫️ المبنى الرئيسي (تركي الأول): https://maps.app.goo.gl/NjeJTWoj4mhK5MUKA?g_st=it\n"
            "▫️ الملز: https://maps.app.goo.gl/4bnaxNA8vMDRSp9D7\n"
            "▫️ الوشم (عيال): https://maps.app.goo.gl/sCo9BkV1WaEeXVGa8?g_st=it\n"
            "▫️ المدينة الجامعية للطالبات: https://maps.app.goo.gl/EZcL9XVz1w8UomYF6?g_st=ic\n\n"
            "https://t.me/SaudDiploma_bot"
        )
        bot.send_message(message.chat.id, msg)
        return

    if text == "التبويب التاسع: التجسير":
        bot.send_message(
            message.chat.id,
            "شروط التجسير في جامعة الملك سعود:\nhttps://t.me/Diploma_Solutions/24"
        )
        return

    if text == "التبويب العاشر: 🛑شرح استخدام – البلاك بورد / Blackboard 🛑":
        bot.send_message(
            message.chat.id,
            "شرح استخدام- البلاك بورد/  Blackboard ⤵️\nhttps://t.me/Diploma_Solutions/16"
        )
        return

    # أي نص غير معروف
    bot.send_message(message.chat.id, "❗ الأمر غير معروف، الرجاء استخدام القائمة.")

# --- استقبال التحديثات من Telegram عبر Webhook ---

@app.route('/' + TOKEN, methods=['POST'])
def webhook():
    json_string = request.get_data().decode('utf-8')
    update = telebot.types.Update.de_json(json_string)
    bot.process_new_updates([update])
    return '', 200

# --- مسار لفحص حالة السيرفر ---

@app.route('/')
def index():
    return "Bot is alive!", 200

if __name__ == '__main__':
    bot.remove_webhook()
    WEBHOOK_URL = f"https://YOUR_DOMAIN_HERE/{TOKEN}"  # غيّر هذا إلى رابطك مع https
    bot.set_webhook(url=WEBHOOK_URL)

    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
            
